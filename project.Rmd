---
title: "Building a Hotel Booking Cancellation Prediction Model"
subtitle: "Using Machine Learning Models to Predict Whether a Hotel Guest would Cancel their Hotel Booking"
author: "Giselle Ramirez"
output: 
  html_document:
    code_folding: hide
subtitle: "FALL 2022"
date: "2022-12-06"
execute:
  message: false
  warning: false
  echo: false
  cache: true
---

![](hotelbookingpic.jpg)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

The purpose of this project is to build machine learning models that can accurately predict whether a hotel guest would cancel their hotel booking. The data that would be used is from 'hotel_booking', and I will build different models that would most accurately predict the binary regression problem.

## Hotel Booking Process

Guests from all over the world are visiting hotels for different reasons. It could range to personal vacation ventures to business trips. In order to book a hotel, the guest must provide information about themselves and what kind of booking they are looking for. For example, they need to provide information on what day and how long they are looking to book the room(s). Also, who is coming along with them, along with other personal information they are looking to get from the hotel, such as parking and special accommodations. Hotels keep track of this and save the guest the room they asked for. However, there are times for any reason where hotel guests cancel their reservation. Hotels, in this case, must cancel the booking for the guest.

```{r}
library(vembedr)
embed_youtube("oUv2BcxAvjQ")
```

## **Why is this model important?**

In this dataset, we are exploring only two hotels: Resort Hotel and City Hotel, which are the closest hotels in the area. In order to keep track of when and if hotel guests will check in, it's important to keep track of hotel booking cancellations. Also, we need to see if certain guest traits will have a higher chance of cancellation so that hotels can be prepared just in case there might be a cancellation.

## **Project Roadmap**

\<insert what models were used\>

## Exploratory Data Analysis

We need to clean up the data and choose our important variables that are relevant to predicting hotel booking cancellation.

### Loading Packages and Data

The dataset was found on Kaggle from Jeese Mostipak, but the [hotel_booking](https://www.kaggle.com/datasets/jessemostipak/hotel-booking-demand) dataset was originally found from an article "Hotel Booking Demand Datasets" by Nuno Antonio, Ana Almedia, and Luis Nunes 2018. The original dataset contains 119390 observations/guests with 32 variables.

However, I will only use the variables that I believe are relevant to predicting hotel booking cancellations. In our case, is_canceled is our response variable, while the other variables are the predictors:

-   `hotel`: Which hotel --\> Resort Hotel or City Hotel
-   `is_canceled`: Whether hotel guest cancelled (1) or didn't cancel (0)
-   `lead_time`: Number of days hotel guest booked reservation in advance
-   arrival_date_year: Year of arrival
-   arrival_date_month: Month of arrival
-   arrival_date_week: Week of arrival (out of 52 weeks in a year)
-   arrival_date_day_of_month: Number of day in a Month
-   stays_in_weekend_nights: How many weekend nights (Saturday and Sunday) hotel guest stayed over
-   stays_in_week_nights: How many week nights (Monday to Friday)
-   adults: Number of adults checking in
-   children: Number of children checking in
-   babies: Number of babies checking in
-   meal: Type of meal package ordered (Undefined/SC - no meal package, BB - Bed and Breakfast, HB - Half board (two meals a day), FB - Full board (three meals a day))
-   country: Which country guest comes from (format: ISO 3155-3:2013), e.g. PRT = Portugal
-   market_segment: How people ordered their hotel booking (Online TA (Travel Agent), Offline TA/TO (Tour Operator), Direct, Corporate, Complementary, Groups, Undefined, Aviation)
-   distribution_channel: How booking was reserved (Direct, Corporate, TA/TO, Undefined, GDS)
-   is_repeated_guest: Not the first time the hotel guest made another hotel booking (1) or first time hotel guest (0)
-   previous_cancellations: Number of previous cancellations by guest before current hotel booking
-   previous_booking_not_cancelled: Number of previous hotel bookings by guest NOT CANCELLED before current hotel booking
-   reserved_room_type: Type of room reserved (C, A, D, E, G, F, H, L, P, B)
-   `assigned_room_type`: Type of room assigned (may differ due to overbooking or room upgrades) (C, A, D, E, G, F, H, L, P, B, I, K)
-   `booking_changes`: Number of hotel booking changes when room(s) were booked until checkout
-   deposit_type: If hotel guest left deposit ("No Deposit" - none made, "Refundable" - deposit made was worth less of hotel stay, "Non Refund" - deposit made was made of entire hotel stay cost)
-   agent: Identification of travel agency that reserved hotel booking for guest
-   company: Identification of company that made booking
-   days_in_waiting_list: Number of days on waitlist before getting accepted to a hotel booking reservation
-   customer_type: Type of booking made (Transient - short and urgent booking for individual, Contract - signed contract for long stay booking, Transient-Party - short and urgent booking for a group, Group - booking for a group)
-   adr: Average Daily Rate (total cost of booking divided by number of days)
-   required_car_parking_spaces: Number of car parking spaces reserved by hotel guest
-   total_of_special_request: Number of total special requests made by hotel guest
-   reservation_status: Final reservation status (Check-Out - Hotel guest checked in and left at end of reservation booking, Canceled - hotel booking cancelled, No-Show - never showed up)
-   reservation_status_date: Date of final reservation status

### Libraries and Dataset Cleaning

```{r include=FALSE, results=}
library(tidymodels)
library(tidyverse)
library(dplyr)
library(corrr)
library(corrplot)
library(ggplot2)
library(discrim)
library(klaR)
library(glmnet)
library(ISLR)
library(rpart.plot)
library(vip)
library(randomForest)
library(xgboost)
library(ranger)
library(tidyr)
library(janitor)
library(knitr)
library(MASS)
library(vembedr)
library(poissonreg)
library(yardstick)
tidymodels_prefer()
```

```{r}
hotel_booking <- read.csv("hotel_bookings.csv") 
set.seed(1234)
hotel_booking %>%
  head()
```

Let's see the dimensions of this dataset.

```{r}
dim(hotel_booking)
```

So we have 119390 individuals that booked hotel reservations and 32 original variables.

Let's see which variables have missing values so that we could replace null values with 0 or unknown. And make sure there is at least one person per hotel booking (so children, adults, and babies cannot be all 0).

```{r}
numeric_book <- unlist(lapply(hotel_booking, is.integer))
data_num <- hotel_booking[, numeric_book]
#data_num
(colMeans(is.na(data_num))) *100

character_book <- unlist(lapply(hotel_booking, is.character))
data_chara <- hotel_booking[, character_book]

sum(is.na(hotel_booking$children)) #4 missing

#count by group

null_country <- data_chara %>%
  group_by(country) %>%
  summarize(n()) %>%
  filter(country == "NULL") %>%
  select('n()')
null_country #488

null_agent <- data_chara %>%
  group_by(agent) %>%
  summarize(n()) %>%
  filter(agent == "NULL") %>%
  select('n()')
null_agent #16340

null_comp <- data_chara %>%
  group_by(company) %>%
  summarize(n()) %>%
  filter(company == "NULL") %>%
  select('n()')
null_comp #112593
```

Based on the code, we see that there are some missing values for children (4), country (488), agent (16340), and company (112593). Due to this, we will fill in 0 for children, agent, and company, and fill in 'UNK' as unknown for country. We will also filter out any hotel room bookings that have zero adults, children, and babies.

```{r}
hotel_booking$children[is.na(hotel_booking$children)] <- 0
hotel_booking$agent <- hotel_booking$agent %>% replace(.=="NULL", "0") 
hotel_booking$company <- hotel_booking$company %>% replace(.=="NULL", "0") 
hotel_booking$country <- hotel_booking$country %>% replace(.=="NULL", "UNK") 
hotel_booking <- hotel_booking %>%
  filter((adults > 0 & babies == 0 & children == 0) |
           (adults == 0 & babies>0 & children == 0) |
           (adults == 0 & babies == 0 & children > 0) |
           (adults >0 | babies >0 | children >0))
head(hotel_booking)
```

Also, I want to make some character variables into numerical variables that I can analyze better. and separate reservation_status_date into year, month, and day in order to analyze the updated date of the hotel booking reservation. I will also factor variables that have levels in order:

```{r}
#ignore warning please
data_chara <- hotel_booking[, unlist(lapply(hotel_booking, is.character))]
colnames(data_chara) #character variables 
#(not include country, agent, company, and reservation_status_date since #there's a lot of unique values for these variables)
list_unique <- data_chara %>%
  select(-country, -agent, -company, -reservation_status_date) %>%
  lapply(unique)
  
hotel_booking <- hotel_booking %>%
  mutate(
    hotel = recode(hotel, 'Resort Hotel' = 0, 'City Hotel' = 1),
    arrival_date_month = recode(arrival_date_month, "January" = 1, 
                                "February" = 2, "March" = 3, 
                                "April" = 4, "May" = 5, "June" = 6, 
                                "July" = 7,"August" = 8, "September" = 9, 
                                "October" = 10, "November" = 11, 
                                "December" = 12),
    meal = recode(meal, "Undefined" = 0, "SC" = 1, "BB" = 2, "HB" = 3, 
                  "FB" = 4), 
    market_segment = recode(market_segment, "Direct" = 0, "Corporate" = 1, 
                            "Online TA" = 2, "Offline TA/TO" = 3, 
                            "complementary" = 4, "Groups" = 5, 
                            "Aviation" = 6, "Undefined" = 7), 
    distribution_channel = recode(distribution_channel, "Direct" = 0, 
                                  "Corporate" = 1, "TA/TO" = 2, 
                                  "Undefined" = 3, "GDS" = 4), 
    reserved_room_type = recode(reserved_room_type, "C" = 0, "A" = 1, 
                                "D" = 2, "E" = 3, "G" = 4, "F" = 5, 
                                "H" = 6, "L" = 7, "B" = 8), 
    assigned_room_type = recode(assigned_room_type, "C" = 0, "A" = 1, 
                                "D" = 2, "E" = 3, "G" = 4, "F" = 5, 
                                "I" = 6, "B" = 7, "H" = 8, "L" = 9, 
                                "K" = 10), 
    deposit_type = recode(deposit_type, "No Deposit" = 0, "Refundable" = 1, 
                          "Non Refund" = 2), 
    customer_type = recode(customer_type, "Transient" = 0, "Contract" = 1, 
                           "Transient-Party" = 2, "Group" = 3), 
    reservation_status = recode(reservation_status, "Check-Out" = 0, 
                                "Canceled" = 1, "No-Show" = 2)) %>% 
  separate(reservation_status_date, c("latest_year", "latest_month", 
                                      "latest_day")) %>% 
  mutate(
    hotel = factor(hotel), 
    meal = factor(meal), 
    market_segment = factor(market_segment),
    distribution_channel = factor(distribution_channel), 
    reserved_room_type= factor(reserved_room_type),
    assigned_room_type = factor(assigned_room_type),
    deposit_type = factor(deposit_type), 
    customer_type = factor(customer_type), 
    reservation_status = factor(reservation_status), 
    is_canceled = factor(is_canceled),
    is_repeated_guest = factor(is_repeated_guest)
  )

head(hotel_booking)
```

## Testing and Training Datasets

Now our data is cleaned up and organized enough to do some EDA with our testing and training sets.

First, let's split our data to our testing and training sets with 80% training and 20% testing.

```{r}
booking_split <- hotel_booking %>%
  initial_split(prop = 0.8, strata = "is_canceled")

booking_train <- training(booking_split)
booking_test <- testing(booking_split)
```

The training set has around 95367 observations, while the testing set has around 23843 observations. Observations in this case are hotel bookings.

Now, let's explore the distribution of the outcome variable called is_canceled.

```{r}
booking_train %>%
  ggplot(aes(x = is_canceled)) +
  geom_bar()
```

As we see here, in our training set, we see that many hotel guests aren't canceling their hotel booking, which is marked by 0 and about 35000 hotel guests end up canceling their reservations.

I also want to see the correlation of all numeric continuous variables to see if they have relations with one another.

```{r}
booking_train %>%
  select_if(is.numeric) %>%
  select(-arrival_date_day_of_month, -babies, -booking_changes, -days_in_waiting_list, -required_car_parking_spaces) %>%
  cor(use = "complete.obs") %>%
  corrplot(order= "original", diag = FALSE)
#original, AOE, FPC, hclust, alphabet

```

I removed some numeric variables that had almost zero correlation with the rest of the numeric variables, which were arrival_date_day_of_month, babies, booking_changes, days_in_waiting_list, and required_car_parking_spaces. I will remove these variables for the recipe later as they are don't have much correlation with each other. As seen here, we see that arrival_date_month and arrival_date_week_number have a very strong positive correlation. This makes sense as when the months go by, so will the weeks. The variables stays_in_week_nights and stays_in_weekend_nights also had a moderate positive correlation, which also makes sense as there are some people that would stay a mix of weekday and weekend nights.

There is also a strong negative correlation between arrival_date_month and arrival_date_year and arrival_date_week_number with arrival_date_year. Both of these relations are interesting, because they suggest that there are more booking towards the later months/weeks of the year.

Let's do a histogram to see if this is true that there is more bookings towards the end of the year for the training set.

```{r}
month_book <- hotel_booking %>%
  count(arrival_date_month, hotel)
month_book

ggplot(month_book, aes(x = arrival_date_month, y = n, fill = hotel)) + 
  geom_bar(stat = "identity", position = 'dodge')
```

As we can see in the barchart above, from January to August, the hotel booking seems to increase and decreases as it approaches December for Resort Hotel (hotel = 0). However, for City Hotel (hotel = 1), the hotel booking seems to stay around the same, only peaking around August.

Now, that I saw the overall pattern of our hotel_booking dataset, lets set up our models!

### Making our Recipes

Now that we built our training and testing sets and observing if there is any correlation within the variables, we need to build a recipe that would be essential in building our models. I excluded variables that had almost no correlation with other variables (which include: `arrival_date_day_of_month`, `babies`, `booking_changes`, `days_in_waiting_list`, `required_car_parking_spaces`), had over 10% missing variables (`agent` and `company`). I also excluded variables that have an almost 100% correlation with the variable `is_canceled` , which are `reservation_status` (detail if the person did check in with the hotel or not), `assigned_room_type` (applies to people who have checked in who changed their room), `booking_changes` (number of changes made to the room once checked in), and `days_in_waiting_list` (confirmed booking). So in total, we will use only 25 of the predictor variables.

```{r}
booking_recipe <- recipe(is_canceled ~ hotel + arrival_date_week_number + stays_in_weekend_nights + stays_in_week_nights + adults + children + meal + market_segment + distribution_channel + is_repeated_guest + previous_cancellations + previous_bookings_not_canceled + reserved_room_type + deposit_type + customer_type + adr + required_car_parking_spaces + latest_year + latest_month + latest_day, data = booking_train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())
```

### K-Fold Cross Validation

Now we are going to use cross-validation to fold the training set as a stratified cross-validation with repeats.

```{r}
booking_folds <- vfold_cv(booking_train, v = 10, strata = is_canceled)
```

## Model Building

Now it is time to build our models! We will use roc_auc as a metric set across our models to see which is our best model. Our models are logistic regression, LDA, QDA, and a decision tree for this binary classification problem.

Let's first start off with building a logistic regression.

### Logistic Regression

First we need to build a logistic regression model with a workflow.

```{r}
log_reg <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

log_wkflow <- workflow() %>%
  add_model(log_reg) %>%
  add_recipe(booking_recipe)

log_fit <- fit(log_wkflow, booking_train)
```

drop: company, adults, babies, children, deposit_type, reservation_status_date, total_nights, arrival_date_week_number, stays_in_weekend_nights, arrival_date_month, agent, arrival_date_week_number, stays_in_weekend_nights, arrival_date_month,

drop: children, adults, and babies (that are all this at same time)

days_in_waiting_list, arrival_date_year, assigned_room_type, booking changes, reservation_status, country,

reservation_status_date (after saving year, month, and day separately), arrival_date_month
